# Asset Traceability System (Google Apps Script + AppSheet)

Google Apps Script backend + AppSheet frontend to prioritize asset handling tasks (e.g. pallets) in a production environment, using Google Sheets as a lightweight database and a 30-minute TTL to auto-release stale tasks.

**Repository:** `appscript-asset-traceability`  
**Author:** Javier Varona ([@jvarona-automation](https://github.com/jvarona-automation))

---

## Overview

This project implements an **asset traceability and prioritization system** for internal material handling operations (such as moving pallets between production lines and storage).

The system is built on:

- **Google Sheets** â€“ acts as the data store.
- **Google Apps Script** â€“ implements the backend logic and priority rules.
- **AppSheet** (or similar) â€“ provides a mobile-friendly frontend for the operators.

The main goals are:

- Give the material handling team **clear visibility** of:
  - How many assets are pending.
  - Which asset has the **highest priority** based on a due datetime or a manual request.
- Keep a **single prioritized work queue**, automatically cleaned up using a Time-To-Live (TTL) mechanism.

---

## Key Features

- ðŸ”„ **Two-source merge**
  - `DataSource_Table`: official data from an external system (ERP export, production report, etc.).
  - `Manual_Input_Table`: manual overrides and additional requests submitted through the frontend (e.g. AppSheet).

- ðŸ§  **Priority logic**
  - Manual records are treated as high priority (`HOURS_REMAINING = -100`).
  - Source records compute `HOURS_REMAINING` from `DUE_DATETIME`.
  - The final queue (`Work_Queue`) is sorted ascending by `HOURS_REMAINING` so the most urgent items appear first.

- â± **Smart TTL (Time-To-Live) â€“ 30 minutes**
  - **Work queue (`Work_Queue`):**  
    Tasks that are claimed but not completed within **30 minutes** are automatically released.
  - **Manual records (`Manual_Input_Table`):**  
    Orphan manual entries expire after **30 minutes** if they are never matched by the source data.

- ðŸ”’ **Safe concurrency**
  - Uses `LockService` to avoid concurrent write conflicts when multiple executions run at the same time.

- ðŸ©¹ **Self-healing sheet structure**
  - Automatically creates or repairs the `Manual_Input_Table` sheet if headers are missing or outdated.

---

## Architecture

### Google Sheets

The solution assumes a single Google Sheets file with three main tabs:

1. **`DataSource_Table`** â€“ Source data (first â€œtruth sourceâ€)
2. **`Manual_Input_Table`** â€“ Manual input and overrides (second â€œtruth sourceâ€)
3. **`Work_Queue`** â€“ Final prioritized work queue generated by the script

### Apps Script Backend

The file `Code.gs` contains all backend logic:

- Reads and merges data from `DataSource_Table` and `Manual_Input_Table`.
- Computes `HOURS_REMAINING` for each record.
- Assigns higher priority to manual records.
- Applies TTL rules for:
  - Long-held, incomplete claims in `Work_Queue`.
  - Old manual records in `Manual_Input_Table`.
- Writes the final prioritized queue into `Work_Queue`.
- Creates/repairs the `Manual_Input_Table` headers.
- Exposes menu actions in the Google Sheet:

  - `Update Queue`
  - `Release Old Tasks`
  - `Create/Repair Manual Sheet`

### AppSheet (or other frontend)

The frontend is typically implemented in **AppSheet**, but any tool that can read/write Google Sheets can be used.

Typical usage:

- Read from `Work_Queue` to show the **prioritized list of tasks** to operators.
- Write to `Manual_Input_Table` when:
  - Creating manual requests.
  - Claiming tasks (`CLAIMED_BY`, `CLAIM_TIME`, `CLAIMED`).
  - Marking tasks as completed (`ARRIVAL_TIME`, `NEW_LOCATION`, `NOTES`).

For a more detailed description of the AppSheet design (views, filters, UX), see:  
`docs/appsheet_frontend.md` *(to be created)*.

---

## Sheet Schemas

### 1. `DataSource_Table` (source data)

Minimum required columns:

| Column        | Type        | Description                                        |
| ------------- | ----------- | -------------------------------------------------- |
| `ID`          | Text        | Unique asset identifier (pallet ID, container IDâ€¦) |
| `LOCATION`    | Text        | Current asset location                              |
| `DUE_DATETIME`| Date/Time   | Expected due datetime for handling                 |
| `TYPE`        | Text        | Category / deviation type (optional)              |
| `SHIFT`       | Text        | Shift identifier (optional)                       |

> You can add more columns if needed; the script only depends on these names.

---

### 2. `Manual_Input_Table` (manual input)

Created or repaired by `setupHojasAdicionales()` with the following headers:

| Column            | Description                                                     |
| ----------------- | --------------------------------------------------------------- |
| `ID`              | Asset identifier (should match `ID` from the source)           |
| `LOCATION`        | Reported location                                               |
| `CLAIMED_BY`      | Who claimed the task                                           |
| `NEW_LOCATION`    | New location after handling                                    |
| `ARRIVAL_TIME`    | Arrival / completion timestamp                                 |
| `NOTES`           | Operator notes                                                 |
| `CLAIM_TIME`      | Timestamp when the task was claimed                            |
| `CLAIMED`         | Boolean, `TRUE` if the task is currently claimed               |
| `FIRST_SEEN_AT`   | Internal timestamp used for TTL of manual records              |
| `MANUAL_RECORD_ID`| Optional internal ID for the manual record (used by frontend)  |

---

### 3. `Work_Queue` (prioritized queue)

Populated by the backend using the `HEADERS` array:

| Column           | Description                                                |
| ---------------- | ---------------------------------------------------------- |
| `ID`             | Asset identifier                                           |
| `LOCATION`       | Current location                                           |
| `HOURS_REMAINING`| Hours remaining until `DUE_DATETIME` (may be negative)     |
| `TYPE`           | Type / category                                           |
| `SHIFT`          | Shift                                                     |
| `ORIGIN`         | Derived origin / line name (based on `LOCATION`)          |
| `CLAIMED_BY`     | Who claimed the task                                      |
| `CLAIM_TIME`     | When the task was claimed                                 |
| `NEW_LOCATION`   | New location after handling                               |
| `NOTES`          | Operator notes                                            |
| `CLAIMED`        | Boolean flag indicating whether the task is claimed       |
| `ARRIVAL_TIME`   | Arrival / completion timestamp                            |

If there are no tasks, the sheet simply contains the text: `No pending tasks.
